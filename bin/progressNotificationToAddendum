#!/bin/bash

printUsage()
{
    progressNotification --help 2>&1 | sed \
	-e '1s#^.*$#Update the user via the addendum of the terminal'\''s window title on the progress reports read from standard input.#' \
	-e '2b removeFirstParagraphLoop' \
	-e '/^ *--to|-o/b removeOptionLoop' \
	-e '/^Usage:$/N' -e '/\(^\|\n\)Usage: */{ s/\(^\|\n\)\(Usage: *\)\?\([^ ]\+ \)*progressNotification /\1\2'"$(basename "$1")"' /; s/-o|--to [^ ]\+ // }' \
	-e '/^Example:$/N' -e '/\(^\|\n\)Example: */{ s/\(^\|\n\)\(Example: *.*| \)\?progressNotification --to overlay /\1\2'"$(basename "$1") / }" \
	-e b -e :removeFirstParagraphLoop -e '{ /\(^\|\n\)$/{ s/^\(.*\n\)\?//; b; }; N; b removeFirstParagraphLoop }' \
	-e b -e :removeOptionLoop -e '{ /\n *--to|-o[^\n]*$/{ N; b removeOptionLoop; }; /\n *--[^\n]*$\|\n[^	 ]\|\n$/{ s/^\(.*\n\)\?//; b; }; N; b removeOptionLoop }'
}
case "$1" in
    --help|-h|-\?)	shift; printUsage "$0"; exit 0;;
esac

if ! type -t titleupdate >/dev/null; then
    echo >&2 'ERROR: titleupdate is not available.'
    exit 3
elif [ -z "$TERMID" ]; then
    echo >&2 'ERROR: Cannot notify via titleupdate; TERMID not defined.'
    exit 3
fi

PROGRESSNOTIFICATION_POST_COMMANDLINE="titleupdate --id progressNotificationToAddendum --clear 2>/dev/null" \
PROGRESSNOTIFICATION_COMMANDLINE="titleupdate --id progressNotificationToAddendum {}" \
exec progressNotification --to command "$@"
